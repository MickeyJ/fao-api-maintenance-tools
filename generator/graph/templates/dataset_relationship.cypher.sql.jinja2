-- Create {{ relationship.type }} relationships from {{ table_name }}
SELECT * FROM cypher('{{ project_name }}', $$
    MATCH (source:{{ relationship.source_node }} {id: row.{{ relationship.source_fk }}})
    MATCH (target:{{ relationship.target_node }} {id: row.{{ relationship.target_fk }}})
    CREATE (source)-[r:{{ relationship.type }} {
        -- Dynamic properties from row
        {% for ref_type in ['element', 'indicator', 'food_value', 'industry', 'factor'] %}
        {% if ref_type + '_codes' in relationship %}
        {{ ref_type }}_code_id: row.{{ ref_type }}_code_id,
        {% endif %}
        {% endfor %}
        year: row.year,
        value: row.value,
        unit: row.unit,
        {% if 'note' in module.model.column_names %}
        note: row.note,
        {% endif %}
        -- Metadata
        source_dataset: '{{ table_name }}'
    }]->(target)
    RETURN r
$$) AS (result agtype)
FROM {{ table_name }} row
WHERE row.{{ relationship.source_fk }} IS NOT NULL
  AND row.{{ relationship.target_fk }} IS NOT NULL
  AND row.value > 0
  {% for ref_type in ['element', 'indicator', 'food_value', 'industry', 'factor'] %}
  {% if ref_type + '_codes' in relationship %}
  AND row.{{ ref_type }}_code IN ({{ relationship[ref_type + '_codes'] | map('string') | join(', ') }})
  {% endif %}
  {% endfor %}
;