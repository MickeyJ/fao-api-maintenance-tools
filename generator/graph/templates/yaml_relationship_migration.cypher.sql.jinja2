-- yaml_relationship_migration.cypher.sql.jinja2
-- Get records to create {{ relationship.type }} relationships from {{ table_name }}
SELECT 
    t.*,
    {% if 'flag' in relationship.properties_from_row %}
    f.flag
    {% else %}
    NULL as flag
    {% endif %}
FROM {{ table_name }} t
{% if 'flag' in relationship.properties_from_row %}
LEFT JOIN flags f ON t.flag_id = f.id
{% endif %}
WHERE t.{{ relationship.source_fk }} IS NOT NULL
  AND t.{{ relationship.target_fk }} IS NOT NULL
  {% if 'value' in relationship.properties_from_row %}
  AND t.value IS NOT NULL
  AND t.value > 0
  {% endif %}
  {% for filter in relationship.filters %}
  {% if filter['field'] == 'element_code' %}
  AND t.element_code IN ({{ filter['values'] | join(', ') }})
  {% endif %}
  {% endfor %}
ORDER BY t.id
LIMIT :limit OFFSET :offset